---
title: "Creating the graph object"
date: "Created: 05-07-2024. Last modified: `r format(Sys.time(), '%d-%m-%Y.')`"
output:
  html_document:
    mathjax: "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
    highlight: pygments
    theme: flatly
    code_folding: show # class.source = "fold-hide" to hide code and add a button to show it
    # df_print: paged
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    number_sections: true
    fig_caption: true
always_allow_html: true
---

```{r, eval = FALSE, echo = FALSE}
################################################################################
################################################################################
################################################################################
################################################################################
######### DO NOT FORGET TO CHANGE THE TITLE EVERY TIME YOU FIT A MODEL #########
################################################################################
################################################################################
################################################################################
################################################################################
```

```{r xaringanExtra-clipboard, echo = FALSE}
htmltools::tagList(
  xaringanExtra::use_clipboard(
    button_text = "<i class=\"fa-solid fa-clipboard\" style=\"color: #00008B\"></i>",
    success_text = "<i class=\"fa fa-check\" style=\"color: #90BE6D\"></i>",
    error_text = "<i class=\"fa fa-times-circle\" style=\"color: #F94144\"></i>"
  ),
  rmarkdown::html_dependency_font_awesome()
)
```


```{css, echo = FALSE}
body .main-container {
  max-width: 100% !important;
  width: 100% !important;
}
body {
  max-width: 100% !important;
}

body, td {
   font-size: 16px;
}
code.r{
  font-size: 14px;
}
pre {
  font-size: 14px
}
```

Go back to the [Preprocessing page](../preprocessing.html). This [link](../data_files/README.html) might be useful to keep track of the files created during the preprocessing.

Let us set some global options for all code chunks in this document.

```{r}
knitr::opts_chunk$set(
  message = FALSE,    # Disable messages printed by R code chunks
  warning = FALSE,    # Disable warnings printed by R code chunks
  echo = TRUE,        # Show R code within code chunks in output
  include = TRUE,     # Include both R code and its results in output
  eval = TRUE,       # Evaluate R code chunks
  cache = FALSE,       # Enable caching of R code chunks for faster rendering
  fig.align = "center",
  out.width = "100%",
  retina = 2,
  error = TRUE,
  collapse = FALSE
)
rm(list = ls())
set.seed(1982)
```

# Import libraries

```{r}
# Install R-INLA package
# install.packages("INLA",repos = c(getOption("repos"),INLA ="https://inla.r-inla-download.org/R/testing"), dep = TRUE)
# Update R-INLA package
# inla.upgrade(testing = TRUE)
# Install inlabru package
# remotes::install_github("inlabru-org/inlabru", ref = "devel")
# Install rSPDE package
# remotes::install_github("davidbolin/rspde", ref = "devel")
# Install MetricGraph package
# remotes::install_github("davidbolin/metricgraph", ref = "devel")

library(INLA)
library(inlabru)
library(rSPDE)
library(MetricGraph)

library(plotly)
library(dplyr)
library(tidyr)
library(sf)
library(mapview)
library(listviewer)
library(jsonlite)
library(ggplot2)

library(here) # here() starts from the home directory
library(rmarkdown)

rm(list = ls()) # Clear the workspace
set.seed(1982) # Set seed for reproducibility
```

# Load the data

```{r}
# Load the data
load(here("data_files/day7142128hour13noconsecutivezeroes.RData")) # just to get the crs

# Load the network from tomtom
load(here("data_files/tomtom.RData")) 
```

## Explore the data

```{r}
tomtom |> head(5) |> paged_table()
tomtom |> dim()
```


```{r}
ggplot(data = tomtom) +
  geom_sf(aes(color = SpeedLimit)) +
  scale_color_viridis_c(option = "D") +
  theme_minimal()
```


# Filter and format the street network data

```{r}
# Build polygon to cut the network and the data
polygon <- st_multipoint(c(st_point(c(-122.53000, 37.69702)),
                          st_point(c(-122.37000, 37.69702)),
                          st_point(c(-122.37000, 37.82600)),
                          st_point(c(-122.53000, 37.82600)))) %>%
  st_cast("POLYGON") %>%
  st_sfc(crs = st_crs(df)) # df dataset needs to be loaded to get the crs

# Filter and prepare the network data
from.tomtom <- tomtom %>%
  dplyr::select(-Id, -Segment.Id, -NewSegId, -timeSet, -dateRange, -standardDeviationSpeed, -travelTimeStandardDeviation) %>% # Remove unnecessary columns
  filter(FRC != "7") %>% # Remove tomtom class 5, 6 and 7 
  mutate(value = SpeedLimit, road_type = paste("class_", FRC, sep = ""), aux = paste("class_", FRC, sep = "")) %>% # Create road_type and aux variables
  pivot_wider(names_from = aux, values_from = value, values_fill = list(value = 0)) %>% # Use aux and value to create one-hot encoding for road_type
  mutate(upto1 = class_0 + class_1) %>% # Create upto1 variable
  mutate(upto3 = upto1 + class_3) %>% # Create upto3 variable
  mutate(upto4 = upto3 + class_4) %>% # Create upto4 variable
  mutate(upto5 = upto4 + class_5) %>% # Create upto5 variable
  mutate(upto6 = upto5 + class_6) %>% # Create upto6 variable
  mutate(Length  = Length/1000) %>%  # Transform Length from meters to kilometers
  mutate(density = sampleSize/Length) %>% # Create density variable (per day)
  mutate(density_per_hour = density/24) %>% # Create density_per_hour variable
  st_transform(crs = st_crs(df)) %>% # Transform to the same crs as the data
  st_filter(x = ., y = polygon, .predicate = st_within) # Filter by the polygon

road_types <- paste0("FRC", paste(sort(unique(from.tomtom$FRC)), collapse = ""))

# Get the weights and edges
weights <- from.tomtom %>% st_drop_geometry()
edges <- from.tomtom$geometry
```

## Explore the data

Data frame `from.tomtom` is the last version of the data before building the graph. Below we explore its structure and show how it looks like.

```{r}
from.tomtom |> head(5) |> paged_table()
from.tomtom |> dim()
```

```{r}
ggplot(data = from.tomtom) +
  geom_sf(aes(color = SpeedLimit)) +
  scale_color_viridis_c(option = "D") +
  theme_minimal()
```


# Build and save the graph

```{r, eval = FALSE}
# Build the graph
graph <- graph_components$new(edges = edges, which_longlat = "sf", longlat = TRUE, edge_weights = weights)

# Get the largest connected component
sf_graph = graph$get_largest()

# Save the graph (notice that it has no data)
save(sf_graph, file = here("data_files/graph_construction_on_27JUN2024_FRC013456.RData"))
```

## Explore the data

```{r, include = FALSE}
load(here("data_files/graph_construction_on_27JUN2024_FRC013456.RData"))
```

Below we show how the graph looks like.

```{r}
sf_graph$plot(vertex_size = 0, 
              edge_width = 1, 
              edge_weight = "SpeedLimit", 
              edge_width_weight = "SpeedLimit", 
              edge_color = "SpeedLimit",
              scale_color_weights = ggplot2::scale_color_viridis_c(option = "D"))
```

```{r}
graph_w <- sf_graph$get_edge_weights()
graph_w |> head(5) |> paged_table()
graph_w |> dim()
```
